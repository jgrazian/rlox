<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>rlox - Rusty Lox Lang</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" rel="stylesheet"
        disabled="true">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width" />
</head>

<body>
    <main>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr;">
            <button class="btn btn-run">Run -></button>
            <h1>rlox</h1>
        </div>
        <div class="split-editor">
            <div class="code language-lox hljs" data-gramm="false" spellcheck="false"
                style="outline: currentcolor none medium; overflow-wrap: break-word; overflow-y: auto; resize: vertical; white-space: pre-wrap;"
                contenteditable="true">
            </div>
            <div class="preview"
                style="outline: currentcolor none medium; overflow-wrap: break-word; overflow-y: auto; resize: vertical; white-space: pre-wrap;"
                contenteditable="false"></div>
        </div>
    </main>

    <script type="module">
        import { CodeJar } from './codejar.js'
        import { withLineNumbers } from './linenumbers.js'
        import init, { run } from './rlox/rlox_lib.js'

        // Setup WASM
        await init();

        let lox = () => {
            return {
                case_insensitive: true,
                keywords: {
                    keyword: 'fun class var for if else while print return or and != == > < >= <=',
                    literal: 'false true nil this super'
                },
                contains: [
                    {
                        scope: 'string',
                        begin: '"', end: '"'
                    },
                    {
                        scope: 'variable',
                        begin: /(?<=var )\w+/,
                        end: /(?=\s*=)/,
                    },
                    {
                        scope: 'title.class',
                        begin: /(?<=class )\w+/,
                        end: /(?=\s*[\{<])/,
                    },
                    {
                        scope: 'title.function',
                        begin: /(?<=fun )\w+/,
                        end: /(?=\s*())/,
                    },
                    hljs.COMMENT(
                        '//', // begin
                        '//', // end
                    )
                ]
            }
        }
        hljs.registerLanguage("lox", lox)

        const editor = document.querySelector('.split-editor .code')
        const preview = document.querySelector('.split-editor .preview')

        const highlight = editor => {
            // highlight.js does not trim old tags,
            // let's do it by this hack.
            editor.textContent = editor.textContent
            hljs.highlightElement(editor)
        }

        const jar = CodeJar(editor, highlight, {
            indentOn: /[(\[{]$/
        })

        jar.updateCode(`fun fib(n) {
\tif (n < 2) return n;
\treturn fib(n - 1) + fib(n - 2); 
}

print fib(10);`)

        jar.onUpdate(code => {
            localStorage.setItem('code', code)
        })

        // Handle button
        const btn = document.querySelector('.btn')
        btn.addEventListener('click', () => {
            localStorage.setItem('code', editor.textContent)
            // jar_out.updateCode(run(jar.toString()))
            console.log(run(jar.toString()))
            preview.textContent = run(jar.toString())
        })

    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
</body>

</html>